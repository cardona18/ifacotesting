<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="report_invoice_document_gi" inherit_id="account.report_invoice_document">


        <xpath expr="//table[@name='invoice_line_table']/thead/tr[1]/th[1]" position="before">
            <th t-if="o.check_lines_cbss()" style="width: 20px">Código de <br/>Identificación</th>
            <th t-if="o.check_lines_sat_code()" style="width: 20px">Código SAT</th>
            <th t-if="o.check_lines_shipment()" style="width: 20px">Número de <br/>pedimento</th>
            <th t-if="o.check_lines_predial()" style="width: 20px">Cuenta <br/>predial</th>
        </xpath>

        <xpath expr="//table[@name='invoice_line_table']/tbody/tr[1]/td[1]" position="before">
            <td t-if="l.product_cbss"><span t-field="l.product_cbss"/></td>
            <td t-if="l.product_id.l10n_mx_edi_code_sat_id.code"><span t-field="l.product_id.l10n_mx_edi_code_sat_id.code"/></td>
            <td t-if="l.shipment_num"><span t-field="l.shipment_num"/></td>
            <td t-if="l.predial_account"><span t-field="l.predial_account"/></td>
        </xpath>

        <xpath expr="//span[@t-field='l.name']" position="after">

            <t t-if="l.import_line_annex">

                <t t-foreach="l.import_line_annex.replace('\\/','/').split('\n')" t-as="ld">
                    <t t-esc="ld" /><br/>
                </t>

            </t>

        </xpath>

        <xpath expr="//span[@t-field='l.uom_id']" position="attributes">
            <attribute name="groups">!sale.group_delivery_invoice_address</attribute>
        </xpath>

        <xpath expr="//tbody[@class='invoice_tbody']/tr[2]" position="attributes">
            <attribute name="groups">!sale.group_delivery_invoice_address</attribute>
        </xpath>

        <xpath expr="//span[@t-field='l.uom_id']" position="after">
            <span t-if="not l.product_uom_cfdi" t-field="l.uom_id"/>
            <span t-if="l.product_uom_cfdi" t-field="l.product_uom_cfdi"/>
        </xpath>

        <xpath expr="//p[@t-if='o.payment_term_id']" position="replace"/>
        <xpath expr="//p[@t-if='o.comment']" position="replace"/>
        <xpath expr="//p[@t-if='o.fiscal_position_id.note']" position="replace"/>

        <xpath expr="//div[@id='total']" position="replace">

            <div id="total" class="row mb16">

                <div class="col-xs-10">

                    <p t-if="o.comment">
                        <span t-field="o.comment"/>
                    </p>
                    <p t-if="o.payment_term_id">
                        <span t-field="o.payment_term_id.note"/>
                    </p>
                    <t t-if="o.l10n_mx_edi_cfdi_uuid">
                        <p>
                            <span t-esc="o.l10n_mx_edi_amount_to_text()"/>
                        </p>
                    </t>
                    <p t-if="o.fiscal_position_id.note">
                        <span t-field="o.fiscal_position_id.note"/>
                    </p>

                </div>

                <div class="col-xs-2">

                    <table class="table-condensed pull-right" style="min-width: 250px;max-width: 400px;">
                        <tr class="border-black" style="border-bottom:1px solid #dddddd;">
                          <td><strong>Subtotal</strong></td>
                          <td class="text-right">
                            <span t-field="o.amount_untaxed" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                          </td>
                        </tr>
                        <t t-set="tax_groups_length" t-value="len(o._get_tax_amount_by_group())"/>
                        <t t-foreach="o._get_tax_amount_by_group()" t-as="amount_by_group">
                            <tr style="border-bottom:1px solid #dddddd;">
                                <t t-if="len(o.tax_line_ids) == 1 and o.amount_untaxed == amount_by_group[2]">
                                    <td><span t-esc="amount_by_group[0]"/></td>
                                    <td class="text-right">
                                        <span t-esc="amount_by_group[1]" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                    </td>
                                </t>
                                <t t-else="">
                                    <td>
                                        <span t-esc="amount_by_group[0]"/>
                                        <span>&amp;nbsp;<span>on</span>
                                            <t t-esc="amount_by_group[2]" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <span t-esc="amount_by_group[1]" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                    </td>
                                </t>
                            </tr>
                        </t>
                        <tr class="border-black">
                            <td><strong>Total</strong></td>
                            <td class="text-right">
                                <span t-field="o.amount_total" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                            </td>
                        </tr>
                    </table>

                </div>

            </div>

        </xpath>

    </template>

    <template id="sale.report_invoice_document_inherit_sale" inherit_id="account.report_invoice_document">

        <xpath expr="//div[@name='invoice_address']" position="attributes">
            <attribute name="groups">!sale.group_delivery_invoice_address</attribute>
        </xpath>
        <xpath expr="//div[@name='invoice_address']" position="before">

            <div class="col-xs-6" groups="sale.group_delivery_invoice_address">

                <div class="mb8">
                    <span t-field="o.partner_id.name" t-if="o.partner_id.id"/><br/>
                    <div t-if="o.partner_id.vat" class="mt2"><t t-esc="o.company_id.country_id.vat_label or 'TIN'"/>: <span t-field="o.partner_id.vat"/></div>
                    <t t-foreach="o.report_format_address().split('\n')" t-as="cal">
                        <t t-esc="cal"/><br/>
                    </t>
                </div>

                <div t-if="o.partner_shipping_id">
                    <strong>Shipping address:</strong>
                    <div>
                        <t t-foreach="o.report_format_address('S').split('\n')" t-as="sal">
                            <t t-esc="sal"/><br/>
                        </t>
                    </div>
                </div>

            </div>

            <div class="col-xs-6" groups="sale.group_delivery_invoice_address" style="padding: 0px;">

                <table class="pull-right" style="font-size: 12px; background: none; border: none; width: 385px">
                    <t t-if="o.l10n_mx_edi_cfdi_uuid">
                        <tr>
                            <th style="padding: 0px;">Folio Fiscal:</th>
                            <td style="padding: 0px; padding-left: 5px; background: none; border: none;"><p style="margin: 0px;" class="text-left" t-esc="tfd.get('UUID')"/></td>
                        </tr>
                    </t>
                    <t t-if="o.l10n_mx_edi_cfdi_uuid">
                        <tr>
                            <th style="padding: 0px;">Lugar de expedición:</th>
                            <td style="padding: 0px; padding-left: 5px; background: none; border: none;"><p style="margin: 0px;" class="text-left" t-esc="xml.get('LugarExpedicion')"/></td>
                        </tr>
                    </t>
                    <t t-if="o.l10n_mx_edi_cfdi_uuid">
                        <tr>
                            <th style="padding: 0px;">Régimen Fiscal:</th>
                            <td style="padding: 0px; padding-left: 5px; background: none; border: none;"><p style="margin: 0px;" class="text-left" t-esc="xml.Emisor.get('RegimenFiscal', '')"/></td>
                        </tr>
                    </t>
                    <t t-if="o.l10n_mx_edi_cfdi_uuid">
                        <tr>
                            <th style="padding: 0px;">Certificado del emisor:</th>
                            <td style="padding: 0px; padding-left: 5px; background: none; border: none;"><p style="margin: 0px;" class="text-left" t-esc="xml.get('noCertificado', xml.get('NoCertificado'))"/></td>
                        </tr>
                    </t>
                    <t t-if="o.l10n_mx_edi_cfdi_uuid">
                        <tr>
                            <th style="padding: 0px;">Fecha de emisión:</th>
                            <td style="padding: 0px; padding-left: 5px; background: none; border: none;"><p style="margin: 0px;" class="text-left" t-esc="xml.get('fecha', xml.get('Fecha', '')).replace('T', ' ')"/></td>
                        </tr>
                    </t>
                    <t t-if="o.l10n_mx_edi_cfdi_uuid">
                        <tr>
                            <th style="padding: 0px;">Fecha de certificación:</th>
                            <td style="padding: 0px; padding-left: 5px; background: none; border: none;"><p style="margin: 0px;" class="text-left" t-esc="tfd.get('FechaTimbrado', '').replace('T', ' ')"/></td>
                        </tr>
                    </t>
                    <t t-if="o.l10n_mx_edi_cfdi_uuid">
                        <tr>
                            <th style="padding: 0px;">Uso CFDI:</th>
                            <td style="padding: 0px; padding-left: 5px; background: none; border: none;"><p style="margin: 0px;" class="text-left" t-esc="xml.Receptor.get('UsoCFDI')"/></td>
                        </tr>
                    </t>
                    <t t-if="o.order_num">
                        <tr>
                            <th style="padding: 0px;">Pedido:</th>
                            <td style="padding: 0px; padding-left: 5px; background: none; border: none;"><p style="margin: 0px;" class="text-left" t-field="o.order_num"/></td>
                        </tr>
                    </t>
                </table>

            </div>
        </xpath>

    </template>

    <template id="l10n_mx_edi.report_invoice_document_mx" inherit_id="account.report_invoice_document">

        <xpath expr="//div[1]" position="before">
            <t t-if="not o.l10n_mx_edi_cfdi_uuid and o.l10n_mx_edi_is_required()">
                <div class="btn btn-danger">
                    <h1>A signature of this invoice is required, but it is not signed.</h1>
                </div>
            </t>
            <t t-if="o.l10n_mx_edi_cfdi_uuid">
                <!--New global variables-->
                <t t-set="xml" t-value="o.l10n_mx_edi_get_xml_etree()"/>
                <t t-set="tfd" t-value="o.l10n_mx_edi_get_tfd_etree(xml)"/>
                <t t-set="tfd_original_string" t-value="o._get_sat_cadena(tfd)"/>
            </t>
        </xpath>

        <xpath expr="//div[@name='invoice_address']" position="inside">
            <t t-if="o.l10n_mx_edi_cfdi_uuid">
                <span t-if="o.partner_id.vat != o.l10n_mx_edi_cfdi_supplier_rfc">XML VAT: <span t-esc="o.l10n_mx_edi_cfdi_supplier_rfc"/></span>
            </t>
        </xpath>

        <xpath expr="//div[@name='reference']" position="after">
            <t t-if="o.l10n_mx_edi_cfdi_uuid">
                <div class="col-xs-2">
                    <strong>Payment Method:</strong>
                    <p t-esc="' - '.join([o.l10n_mx_edi_payment_method_id.code, o.l10n_mx_edi_payment_method_id.name])"/>
                </div>
                <div class="col-xs-2">
                    <strong>Payment Type:</strong>
                    <p t-esc="xml.get('formaDePago', xml.get('MetodoPago'))"/>
                </div>
                <div class="col-xs-2" t-if="xml.get('NumCtaPago')">
                    <strong>Bank Account:</strong>
                    <p t-esc="xml.get('NumCtaPago')"/>
                </div>
            </t>
        </xpath>

        <xpath expr="//p[@t-if='o.fiscal_position_id.note']" position="after">
            <t t-if="o.l10n_mx_edi_cfdi_uuid">
                <div class="row" id="complement">
                    <div class="barcode col-xs-3">
                        <img t-att-src="'/report/barcode/QR/https:/verificacfdi.facturaelectronica.sat.gob.mx/default.aspx%sid=%sre=%srr=%stt=%sfe=%s' % (
                            quote_plus('?'),
                            tfd.get('UUID') + '&amp;',
                            xml.Emisor.get('Rfc') + '&amp;',
                            xml.Receptor.get('Rfc') + '&amp;',
                            xml.get('Total') + '&amp;',
                            tfd.get('SelloCFD')[:8]
                        )"/>
                    </div>
                    <div class="complement-details col-xs-9">
                        <div class="digital-stamp">
                            <span>Digital stamp of the emitter</span>
                        </div>
                        <div class="digital-stamp-content">
                            <span t-esc="xml.get('sello', xml.get('Sello', 'No identificado'))"/>
                        </div>
                        <div class="digital-stamp">
                            <span>Digital stamp SAT</span>
                        </div>
                        <div class="digital-stamp-content">
                            <span t-esc="tfd.get('selloSAT', tfd.get('SelloSAT', 'No identificado'))"/>
                        </div>
                        <div class="digital-stamp">
                            <span>Original chain complement of digital certification SAT</span>
                        </div>
                        <div class="digital-stamp-content">
                            <span class="nowrap" t-esc="tfd_original_string"/>
                        </div>
                        <div t-if="xml.Emisor.xpath('cfdi:ExpedidoEn', namespaces=xml.nsmap)" class="digital-stamp">
                            <span>Issued from</span>
                        </div>
                        <div t-if="xml.Emisor.xpath('cfdi:ExpedidoEn', namespaces=xml.nsmap)" class="digital-stamp-content">
                            <span t-esc="' | '.join([ '%s: %s' % (key, value) for key, value in xml.Emisor.ExpedidoEn.items()])"/>
                        </div>
                        <div class="digital-stamp">
                            <span>Extra Info</span>
                        </div>
                        <div class="digital-stamp-content">
                            <span>Emitter certificate:</span> <span t-esc="xml.get('noCertificado', xml.get('NoCertificado'))"/>
                            <span> | Expedition place:</span> <span t-esc="xml.get('LugarExpedicion')"/>
                            <span> | Fiscal Regime:</span>
                                <t t-if="xml.get('version', '') == '3.2'"> <span t-esc="xml.Emisor.RegimenFiscal.get('Regimen')"/></t>
                                <t t-if="xml.get('Version', '') == '3.3'"> <span t-esc="xml.Emisor.get('RegimenFiscal', '')"/></t>
                            <span> | Emission Date:</span> <span t-esc="xml.get('fecha', xml.get('Fecha', '')).replace('T', ' ')"/>
                            <span> | Certification Date:</span> <span t-esc="tfd.get('FechaTimbrado', '').replace('T', ' ')"/>
                            <span> | Fiscal Folio:</span> <span t-esc="tfd.get('UUID')"/>
                        </div>
                        <div class="digital-stamp-content text-center">
                            <strong>This document is a printed representation of a CFDI</strong>
                        </div>
                    </div>
                </div>
            </t>
        </xpath>

    </template>

    <!-- REPORT HEADER & FOOTER -->

    <template id="invoice_document_header_footer_gi" inherit_id="web.external_layout_clean">

        <xpath expr="//div[@class='footer o_clean_footer']" position="replace">
            <div class="footer o_clean_footer">
                <div class="row mt4">
                    <div class="col-xs-3">
                        <span t-field="company.report_footer"/>
                    </div>
                    <div class="col-xs-4 text-right">
                        <span class="company_address" t-field="company.partner_id" t-field-options="{&quot;widget&quot;: &quot;contact&quot;, &quot;fields&quot;: [&quot;address&quot;], &quot;no_marker&quot;: true}"/>
                    </div>
                    <div class="col-xs-4">
                        <h4 class="mt0 mb0 text-uppercase" t-field="company.report_header"/>
                    </div>
                    <div class="col-xs-1">
                        <ul class="list-inline pagenumber pull-right text-center" style="width: 50px">
                            <li><strong><span class="page"/> / <span class="topage"/></strong></li>
                        </ul>
                    </div>
                </div>
            </div>
        </xpath>

    </template>

</odoo>